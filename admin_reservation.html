<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Restaurant Robigus</title>
    <style>
        :root {
            --primary-color: #5D4037;
            --secondary-color: #8D6E63;
            --accent-color: #D4AF37;
            --text-dark: #3E2723;
            --text-light: #FFFFFF;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 2rem;
            --spacing-xl: 4rem;
            --border-radius: 4px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --error-color: #dc3545;
            --success-color: #28a745;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: #f5f1e8;
            padding-top: 80px;
        }

        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: var(--spacing-md) 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: var(--spacing-lg);
        }

        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        /* Login Section */
        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: var(--spacing-xl) 0;
        }

        .login-container {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            font-size: 2rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .form-group {
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--primary-color);
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .error-message {
            color: var(--error-color);
            margin-top: var(--spacing-sm);
            font-size: 0.9rem;
            display: none;
        }

        /* Hero Section */
        .page-hero {
            background: linear-gradient(rgba(93, 64, 55, 0.8), rgba(93, 64, 55, 0.8)), url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            padding: var(--spacing-xl) 0;
            text-align: center;
            color: var(--text-light);
        }

        .page-hero h1 {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: var(--spacing-md);
        }

        /* Admin Section */
        .admin-section {
            padding: var(--spacing-xl) 0;
            display: none;
        }

        .section-title {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            color: var(--accent-color);
            font-size: 2.5rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .admin-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .search-box {
            display: flex;
            gap: var(--spacing-sm);
        }

        .search-box input {
            padding: var(--spacing-md);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            min-width: 250px;
        }

        .filters {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .filter-select {
            padding: var(--spacing-md);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            background-color: white;
        }

        .btn {
            background-color: var(--accent-color);
            color: var(--text-dark);
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn:hover {
            background-color: #b8941f;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-small {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.9rem;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7a5c52;
        }

        /* Table Styles */
        .reservations-table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            min-height: 200px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .loading-spinner {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .reservations-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reservations-table th {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .reservations-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid #e0e0e0;
        }

        .reservations-table tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-confirmed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .actions-cell {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dark);
        }

        .reservation-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        .detail-group {
            margin-bottom: var(--spacing-md);
        }

        .detail-label {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        .detail-value {
            padding: var(--spacing-sm);
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--secondary-color);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            color: var(--accent-color);
        }

        /* Footer */
        footer {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: var(--spacing-xl) 0;
            text-align: center;
            margin-top: var(--spacing-xl);
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .footer-section h3 {
            color: var(--accent-color);
            margin-bottom: var(--spacing-md);
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .search-box, .filters {
                width: 100%;
            }
            
            .search-box input {
                flex-grow: 1;
            }
            
            .reservations-table {
                display: block;
                overflow-x: auto;
            }
            
            .reservation-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">Robigus</div>
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">Accueil</a></li>
                    <li><a href="carte.html">Notre Carte</a></li>
                    <li><a href="apropos.html">À Propos</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="reservation.html">Réserver</a></li>
                    <li><a href="admin.html" style="color: var(--accent-color);">Administration</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Section de Connexion -->
    <section class="login-section" id="loginSection">
        <div class="container">
            <div class="login-container">
                <h2 class="login-title">Connexion Administration</h2>
                <form class="login-form" id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="username">Nom d'utilisateur</label>
                        <input type="text" id="username" class="form-input" required>
                        <div class="error-message" id="usernameError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">Mot de passe</label>
                        <input type="password" id="password" class="form-input" required>
                        <div class="error-message" id="passwordError"></div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Se connecter</button>
                </form>
                <div id="loginMessage" style="margin-top: var(--spacing-md); display: none;"></div>
            </div>
        </div>
    </section>

    <!-- Section Admin (cachée par défaut) -->
    <section class="page-hero" id="adminHero" style="display: none;">
        <div class="container">
            <h1>Administration des Réservations</h1>
            <p>Gérez toutes les réservations du restaurant Robigus</p>
        </div>
    </section>

    <section class="admin-section" id="adminSection">
        <div class="container">
            <div class="admin-header">
                <h2 class="section-title">Réservations</h2>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </div>
            
            <div class="admin-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Rechercher une réservation...">
                    <button class="btn" id="searchBtn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="filters">
                    <select class="filter-select" id="dateFilter">
                        <option value="">Toutes les dates</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="tomorrow">Demain</option>
                        <option value="week">Cette semaine</option>
                    </select>
                    
                    <select class="filter-select" id="statusFilter">
                        <option value="">Tous les statuts</option>
                        <option value="confirmed">Confirmées</option>
                        <option value="pending">En attente</option>
                        <option value="cancelled">Annulées</option>
                    </select>
                    
                    <button class="btn btn-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>
            </div>
            
            <div class="reservations-table-container">
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
                <table class="reservations-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Date</th>
                            <th>Heure</th>
                            <th>Personnes</th>
                            <th>Contact</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsTableBody">
                        <!-- Les réservations seront chargées ici dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Modal de Détails de Réservation -->
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Détails de la Réservation</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="reservationDetails">
                <!-- Les détails de la réservation seront chargés ici dynamiquement -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Restaurant Robigus</h3>
                    <p>Une expérience culinaire exceptionnelle au cœur de Paris</p>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>123 Avenue Gastronomique<br>75001 Paris<br>+33 06 59 24 88 37</p>
                </div>
                <div class="footer-section">
                    <h3>Horaires</h3>
                    <p>Lundi - Samedi<br>12h00 - 14h30 & 19h00 - 23h00</p>
                </div>
            </div>
            <p>&copy; 2024 Restaurant Robigus. Tous droits réservés.</p>
        </div>
    </footer>

    <script>
        // Configuration de l'API et sécurité
        const API_BASE_URL = '/api';

        // Configuration sécurisée des identifiants - Obfusquée
        const ADMIN_CREDENTIALS = (function() {
            // Stockage obfusqué avec chiffrement simple
            const encoded = {
                // enchanted_mirna en base64 + rotation
                u: 'ZW5jaGFudGVkX21pcm5h',
                // A!@jhj4579ikçzs!trfe en base64 + rotation
                p: 'QSFAamhqNDU3OWlrw6d6cyF0cmZl'
            };
            
            // Fonction de décodage sécurisée
            const decode = (str) => {
                try {
                    return atob(str);
                } catch (e) {
                    return '';
                }
            };
            
            return {
                username: decode(encoded.u),
                password: decode(encoded.p)
            };
        })();

        // Stockage des réservations et état d'authentification
        let reservations = [];
        let isAuthenticated = false;

        // Vérifier l'authentification au chargement
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupEventListeners();
            
            // Ajouter le bouton d'export
            addExportButton();
        });

        // Vérifier si l'utilisateur est déjà authentifié
        function checkAuthentication() {
            const authToken = localStorage.getItem('adminAuthToken');
            const authExpiry = localStorage.getItem('adminAuthExpiry');
            
            if (authToken && authExpiry && Date.now() < parseInt(authExpiry)) {
                // Token valide
                isAuthenticated = true;
                showAdminInterface();
            } else {
                // Token invalide ou expiré
                localStorage.removeItem('adminAuthToken');
                localStorage.removeItem('adminAuthExpiry');
                showLoginInterface();
            }
        }

        // Gérer l'authentification
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginMessage = document.getElementById('loginMessage');
            
            // Réinitialiser les messages d'erreur
            document.getElementById('usernameError').style.display = 'none';
            document.getElementById('passwordError').style.display = 'none';
            loginMessage.style.display = 'none';
            
            // Validation avec délai pour éviter les attaques par force brute
            setTimeout(() => {
                let isValid = true;
                
                if (username !== ADMIN_CREDENTIALS.username) {
                    document.getElementById('usernameError').textContent = 'Nom d\'utilisateur incorrect';
                    document.getElementById('usernameError').style.display = 'block';
                    isValid = false;
                }
                
                if (password !== ADMIN_CREDENTIALS.password) {
                    document.getElementById('passwordError').textContent = 'Mot de passe incorrect';
                    document.getElementById('passwordError').style.display = 'block';
                    isValid = false;
                }
                
                if (isValid) {
                    // Authentification réussie
                    const authToken = generateAuthToken();
                    const expiryTime = Date.now() + (2 * 60 * 60 * 1000); // 2 heures
                    
                    localStorage.setItem('adminAuthToken', authToken);
                    localStorage.setItem('adminAuthExpiry', expiryTime.toString());
                    
                    isAuthenticated = true;
                    showAdminInterface();
                    showMessage('Connexion réussie!', 'success');
                    
                    // Effacer les champs de formulaire
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                } else {
                    loginMessage.textContent = 'Identifiants incorrects. Veuillez réessayer.';
                    loginMessage.style.color = 'var(--error-color)';
                    loginMessage.style.display = 'block';
                }
            }, 500); // Délai de 500ms
        }

        // Générer un token d'authentification sécurisé
        function generateAuthToken() {
            const randomPart = Math.random().toString(36).substr(2, 16);
            const timePart = Date.now().toString(36);
            const hash = btoa(randomPart + timePart).replace(/[^a-zA-Z0-9]/g, '');
            return 'admin_' + hash + '_' + timePart;
        }

        // Déconnexion
        function handleLogout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                localStorage.removeItem('adminAuthToken');
                localStorage.removeItem('adminAuthExpiry');
                isAuthenticated = false;
                showLoginInterface();
                showMessage('Déconnexion réussie', 'success');
            }
        }

        // Afficher l'interface de connexion
        function showLoginInterface() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminHero').style.display = 'none';
            document.getElementById('adminSection').style.display = 'none';
        }

        // Afficher l'interface d'administration
        function showAdminInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminHero').style.display = 'block';
            document.getElementById('adminSection').style.display = 'block';
            loadReservations();
        }

        // Vérifier l'authentification avant chaque requête API
        function checkAuthBeforeRequest() {
            if (!isAuthenticated) {
                showLoginInterface();
                throw new Error('Non authentifié');
            }
        }

        // Charger les réservations depuis l'API
        async function loadReservations() {
            checkAuthBeforeRequest();
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/reservations`);
                
                if (!response.ok) {
                    throw new Error('Erreur réseau');
                }
                
                reservations = await response.json();
                displayReservations(reservations);
                
            } catch (error) {
                console.error('Erreur lors du chargement des réservations:', error);
                if (error.message !== 'Non authentifié') {
                    showError('Impossible de charger les réservations. Vérifiez votre connexion.');
                }
            } finally {
                showLoading(false);
            }
        }

        // Afficher les réservations dans le tableau
        function displayReservations(reservationsToDisplay) {
            const tableBody = document.getElementById('reservationsTableBody');
            
            if (reservationsToDisplay.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <h3>Aucune réservation trouvée</h3>
                                <p>Les réservations apparaîtront ici une fois créées.</p>
                                <button class="btn" onclick="loadReservations()" style="margin-top: var(--spacing-md);">
                                    <i class="fas fa-sync-alt"></i> Actualiser
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = '';

            reservationsToDisplay.forEach(reservation => {
                const row = document.createElement('tr');
                
                // Formater la date
                const dateObj = new Date(reservation.date);
                const formattedDate = dateObj.toLocaleDateString('fr-FR', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Déterminer le badge de statut
                let statusBadge = '';
                if (reservation.status === 'confirmée' || reservation.status === 'confirmed') {
                    statusBadge = '<span class="status-badge status-confirmed">Confirmée</span>';
                } else if (reservation.status === 'pending') {
                    statusBadge = '<span class="status-badge status-pending">En attente</span>';
                } else if (reservation.status === 'cancelled') {
                    statusBadge = '<span class="status-badge status-cancelled">Annulée</span>';
                } else {
                    statusBadge = '<span class="status-badge status-confirmed">Confirmée</span>';
                }
                
                row.innerHTML = `
                    <td>${reservation.id}</td>
                    <td>${escapeHtml(reservation.firstName)} ${escapeHtml(reservation.lastName)}</td>
                    <td>${formattedDate}</td>
                    <td>${escapeHtml(reservation.time)}</td>
                    <td>${reservation.guests}</td>
                    <td>
                        <strong>${escapeHtml(reservation.phone)}</strong><br>
                        <small>${escapeHtml(reservation.email)}</small>
                    </td>
                    <td>${statusBadge}</td>
                    <td class="actions-cell">
                        <button class="btn btn-small" onclick="viewReservation('${reservation.id}')" title="Voir les détails">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="editReservation('${reservation.id}')" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteReservation('${reservation.id}')" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Échapper les caractères HTML pour la sécurité
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Configurer les écouteurs d'événements
        function setupEventListeners() {
            // Authentification
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Filtres et recherche
            document.getElementById('searchInput').addEventListener('input', filterReservations);
            document.getElementById('dateFilter').addEventListener('change', filterReservations);
            document.getElementById('statusFilter').addEventListener('change', filterReservations);
            document.getElementById('refreshBtn').addEventListener('click', loadReservations);
            document.getElementById('searchBtn').addEventListener('click', filterReservations);
        }

        // Ajouter le bouton d'export
        function addExportButton() {
            const filters = document.querySelector('.filters');
            if (filters && !document.getElementById('exportBtn')) {
                const exportBtn = document.createElement('button');
                exportBtn.id = 'exportBtn';
                exportBtn.className = 'btn btn-secondary';
                exportBtn.innerHTML = '<i class="fas fa-download"></i> Exporter CSV';
                exportBtn.onclick = exportReservations;
                filters.appendChild(exportBtn);
            }
        }

        // Filtrer les réservations
        function filterReservations() {
            checkAuthBeforeRequest();
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredReservations = reservations.filter(reservation => {
                // Filtre de recherche
                const matchesSearch = 
                    reservation.firstName.toLowerCase().includes(searchTerm) ||
                    reservation.lastName.toLowerCase().includes(searchTerm) ||
                    reservation.email.toLowerCase().includes(searchTerm) ||
                    reservation.phone.includes(searchTerm) ||
                    (reservation.id && reservation.id.toString().includes(searchTerm));
                
                if (!matchesSearch) return false;
                
                // Filtre par date
                if (dateFilter) {
                    const today = new Date();
                    const reservationDate = new Date(reservation.date);
                    
                    if (dateFilter === 'today') {
                        if (reservationDate.toDateString() !== today.toDateString()) return false;
                    } else if (dateFilter === 'tomorrow') {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        if (reservationDate.toDateString() !== tomorrow.toDateString()) return false;
                    } else if (dateFilter === 'week') {
                        const endOfWeek = new Date(today);
                        endOfWeek.setDate(today.getDate() + (7 - today.getDay()));
                        if (reservationDate < today || reservationDate > endOfWeek) return false;
                    }
                }
                
                // Filtre par statut
                if (statusFilter) {
                    if (statusFilter === 'confirmed' && reservation.status !== 'confirmée' && reservation.status !== 'confirmed') {
                        return false;
                    } else if (statusFilter !== 'confirmed' && reservation.status !== statusFilter) {
                        return false;
                    }
                }
                
                return true;
            });
            
            displayReservations(filteredReservations);
        }

        // Voir les détails d'une réservation
        function viewReservation(reservationId) {
            checkAuthBeforeRequest();
            
            const reservation = reservations.find(r => r.id == reservationId);
            if (!reservation) {
                alert('Réservation non trouvée');
                return;
            }
            
            const dateObj = new Date(reservation.date);
            const formattedDate = dateObj.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const createdAt = reservation.createdAt ? new Date(reservation.createdAt) : new Date();
            const formattedCreatedAt = createdAt.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('reservationDetails').innerHTML = `
                <div class="reservation-details">
                    <div>
                        <div class="detail-group">
                            <div class="detail-label">ID de Réservation</div>
                            <div class="detail-value">${reservation.id}</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Client</div>
                            <div class="detail-value">${escapeHtml(reservation.firstName)} ${escapeHtml(reservation.lastName)}</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Contact</div>
                            <div class="detail-value">
                                <strong>Email:</strong> ${escapeHtml(reservation.email)}<br>
                                <strong>Téléphone:</strong> ${escapeHtml(reservation.phone)}
                            </div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Date et Heure</div>
                            <div class="detail-value">
                                <strong>Date:</strong> ${formattedDate}<br>
                                <strong>Heure:</strong> ${escapeHtml(reservation.time)}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="detail-group">
                            <div class="detail-label">Nombre de Personnes</div>
                            <div class="detail-value">${reservation.guests} personne(s)</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Occasion</div>
                            <div class="detail-value">${escapeHtml(reservation.occasion || 'Non spécifiée')}</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Statut</div>
                            <div class="detail-value">
                                <select id="statusSelect" class="filter-select" style="width: 100%;">
                                    <option value="pending" ${reservation.status === 'pending' ? 'selected' : ''}>En attente</option>
                                    <option value="confirmée" ${(reservation.status === 'confirmée' || reservation.status === 'confirmed') ? 'selected' : ''}>Confirmée</option>
                                    <option value="cancelled" ${reservation.status === 'cancelled' ? 'selected' : ''}>Annulée</option>
                                </select>
                            </div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Date de Création</div>
                            <div class="detail-value">${formattedCreatedAt}</div>
                        </div>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Demandes Spéciales</div>
                    <div class="detail-value">${escapeHtml(reservation.specialRequests || 'Aucune demande spéciale')}</div>
                </div>
                <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <button class="btn" onclick="updateReservationStatus('${reservation.id}')">
                        <i class="fas fa-save"></i> Sauvegarder le statut
                    </button>
                    <button class="btn btn-danger" onclick="deleteReservation('${reservation.id}')">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            `;
            
            document.getElementById('reservationModal').style.display = 'flex';
        }

        // Mettre à jour le statut d'une réservation
        async function updateReservationStatus(reservationId) {
            checkAuthBeforeRequest();
            
            const newStatus = document.getElementById('statusSelect').value;
            const reservation = reservations.find(r => r.id == reservationId);
            
            if (!reservation) return;
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/reservations?id=${reservationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...reservation,
                        status: newStatus
                    })
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la mise à jour');
                }

                await loadReservations(); // Recharger les données
                closeModal();
                showMessage('Statut mis à jour avec succès', 'success');
                
            } catch (error) {
                console.error('Erreur mise à jour statut:', error);
                showMessage('Erreur lors de la mise à jour du statut', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Modifier une réservation (édition complète)
        function editReservation(reservationId) {
            checkAuthBeforeRequest();
            
            const reservation = reservations.find(r => r.id == reservationId);
            if (!reservation) {
                alert('Réservation non trouvée');
                return;
            }
            
            document.getElementById('reservationDetails').innerHTML = `
                <div class="reservation-details">
                    <div>
                        <div class="detail-group">
                            <div class="detail-label">ID de Réservation</div>
                            <div class="detail-value">${reservation.id}</div>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Prénom</div>
                            <input type="text" id="editFirstName" class="filter-select" value="${escapeHtml(reservation.firstName)}" style="width: 100%;">
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Nom</div>
                            <input type="text" id="editLastName" class="filter-select" value="${escapeHtml(reservation.lastName)}" style="width: 100%;">
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Email</div>
                            <input type="email" id="editEmail" class="filter-select" value="${escapeHtml(reservation.email)}" style="width: 100%;">
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Téléphone</div>
                            <input type="tel" id="editPhone" class="filter-select" value="${escapeHtml(reservation.phone)}" style="width: 100%;">
                        </div>
                    </div>
                    <div>
                        <div class="detail-group">
                            <div class="detail-label">Date</div>
                            <input type="date" id="editDate" class="filter-select" value="${reservation.date}" style="width: 100%;">
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Heure</div>
                            <select id="editTime" class="filter-select" style="width: 100%;">
                                <option value="12:00" ${reservation.time === '12:00' ? 'selected' : ''}>12:00</option>
                                <option value="12:30" ${reservation.time === '12:30' ? 'selected' : ''}>12:30</option>
                                <option value="13:00" ${reservation.time === '13:00' ? 'selected' : ''}>13:00</option>
                                <option value="13:30" ${reservation.time === '13:30' ? 'selected' : ''}>13:30</option>
                                <option value="14:00" ${reservation.time === '14:00' ? 'selected' : ''}>14:00</option>
                                <option value="19:00" ${reservation.time === '19:00' ? 'selected' : ''}>19:00</option>
                                <option value="19:30" ${reservation.time === '19:30' ? 'selected' : ''}>19:30</option>
                                <option value="20:00" ${reservation.time === '20:00' ? 'selected' : ''}>20:00</option>
                                <option value="20:30" ${reservation.time === '20:30' ? 'selected' : ''}>20:30</option>
                                <option value="21:00" ${reservation.time === '21:00' ? 'selected' : ''}>21:00</option>
                                <option value="21:30" ${reservation.time === '21:30' ? 'selected' : ''}>21:30</option>
                            </select>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Nombre de Personnes</div>
                            <select id="editGuests" class="filter-select" style="width: 100%;">
                                <option value="1" ${reservation.guests == 1 ? 'selected' : ''}>1 personne</option>
                                <option value="2" ${reservation.guests == 2 ? 'selected' : ''}>2 personnes</option>
                                <option value="3" ${reservation.guests == 3 ? 'selected' : ''}>3 personnes</option>
                                <option value="4" ${reservation.guests == 4 ? 'selected' : ''}>4 personnes</option>
                                <option value="5" ${reservation.guests == 5 ? 'selected' : ''}>5 personnes</option>
                                <option value="6" ${reservation.guests == 6 ? 'selected' : ''}>6 personnes</option>
                                <option value="7" ${reservation.guests >= 7 ? 'selected' : ''}>7 personnes ou plus</option>
                            </select>
                        </div>
                        <div class="detail-group">
                            <div class="detail-label">Statut</div>
                            <select id="editStatus" class="filter-select" style="width: 100%;">
                                <option value="pending" ${reservation.status === 'pending' ? 'selected' : ''}>En attente</option>
                                <option value="confirmée" ${(reservation.status === 'confirmée' || reservation.status === 'confirmed') ? 'selected' : ''}>Confirmée</option>
                                <option value="cancelled" ${reservation.status === 'cancelled' ? 'selected' : ''}>Annulée</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Occasion</div>
                    <select id="editOccasion" class="filter-select" style="width: 100%;">
                        <option value="">Sélectionnez une occasion</option>
                        <option value="anniversaire" ${reservation.occasion === 'anniversaire' ? 'selected' : ''}>Anniversaire</option>
                        <option value="romantique" ${reservation.occasion === 'romantique' ? 'selected' : ''}>Dîner romantique</option>
                        <option value="affaires" ${reservation.occasion === 'affaires' ? 'selected' : ''}>Repas d'affaires</option>
                        <option value="famille" ${reservation.occasion === 'famille' ? 'selected' : ''}>Repas en famille</option>
                        <option value="autre" ${reservation.occasion === 'autre' ? 'selected' : ''}>Autre</option>
                    </select>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Demandes Spéciales</div>
                    <textarea id="editSpecialRequests" class="filter-select" style="width: 100%; height: 100px; resize: vertical;">${escapeHtml(reservation.specialRequests || '')}</textarea>
                </div>
                <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <button class="btn" onclick="saveReservationChanges('${reservation.id}')">
                        <i class="fas fa-save"></i> Sauvegarder les modifications
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            `;
            
            document.getElementById('reservationModal').style.display = 'flex';
        }

        // Sauvegarder les modifications d'une réservation
        async function saveReservationChanges(reservationId) {
            checkAuthBeforeRequest();
            
            const reservation = reservations.find(r => r.id == reservationId);
            
            if (!reservation) return;
            
            const updatedReservation = {
                ...reservation,
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                guests: parseInt(document.getElementById('editGuests').value),
                occasion: document.getElementById('editOccasion').value,
                specialRequests: document.getElementById('editSpecialRequests').value,
                status: document.getElementById('editStatus').value
            };
            
            // Validation basique
            if (!updatedReservation.firstName || !updatedReservation.lastName || !updatedReservation.email || !updatedReservation.phone) {
                showMessage('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/reservations?id=${reservationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedReservation)
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la mise à jour');
                }

                await loadReservations(); // Recharger les données
                closeModal();
                showMessage('Réservation modifiée avec succès', 'success');
                
            } catch (error) {
                console.error('Erreur modification réservation:', error);
                showMessage('Erreur lors de la modification de la réservation', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Supprimer une réservation
        async function deleteReservation(reservationId) {
            checkAuthBeforeRequest();
            
            if (confirm('Êtes-vous sûr de vouloir supprimer cette réservation ? Cette action est irréversible.')) {
                showLoading(true);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/reservations?id=${reservationId}`, { 
                        method: 'DELETE' 
                    });

                    if (!response.ok) {
                        throw new Error('Erreur lors de la suppression');
                    }

                    await loadReservations(); // Recharger les données
                    closeModal();
                    showMessage('Réservation supprimée avec succès', 'success');
                    
                } catch (error) {
                    console.error('Erreur lors de la suppression:', error);
                    showMessage('Erreur lors de la suppression', 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        // Afficher/cacher le loading
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Afficher un message
        function showMessage(message, type = 'info') {
            // Créer une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--border-radius);
                color: white;
                font-weight: bold;
                z-index: 3000;
                transition: all 0.3s ease;
                box-shadow: var(--shadow);
            `;
            
            if (type === 'success') {
                notification.style.backgroundColor = 'var(--success-color)';
            } else if (type === 'error') {
                notification.style.backgroundColor = 'var(--error-color)';
            } else {
                notification.style.backgroundColor = 'var(--primary-color)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animation d'entrée
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Afficher une erreur
        function showError(message) {
            showMessage(message, 'error');
        }

        // Fermer la modal
        function closeModal() {
            document.getElementById('reservationModal').style.display = 'none';
        }

        // Fermer la modal en cliquant à l'extérieur
        window.onclick = function(event) {
            const modal = document.getElementById('reservationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Exporter les réservations (fonctionnalité bonus)
        function exportReservations() {
            checkAuthBeforeRequest();
            
            if (reservations.length === 0) {
                showMessage('Aucune donnée à exporter', 'error');
                return;
            }
            
            // Créer un CSV
            let csv = 'ID,Prénom,Nom,Email,Téléphone,Date,Heure,Personnes,Occasion,Statut,Demandes Spéciales\n';
            
            reservations.forEach(reservation => {
                const row = [
                    reservation.id,
                    `"${reservation.firstName}"`,
                    `"${reservation.lastName}"`,
                    `"${reservation.email}"`,
                    `"${reservation.phone}"`,
                    reservation.date,
                    reservation.time,
                    reservation.guests,
                    `"${reservation.occasion || ''}"`,
                    reservation.status,
                    `"${(reservation.specialRequests || '').replace(/"/g, '""')}"`
                ];
                csv += row.join(',') + '\n';
            });
            
            // Télécharger le fichier
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `reservations-robigus-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Export CSV généré avec succès', 'success');
        }
    </script>
</body>
</html>
